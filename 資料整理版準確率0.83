import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import LabelEncoder
from sklearn.metrics import accuracy_score, recall_score, precision_score, classification_report

# 讀取資料
df = pd.read_csv('seattle_weather_processed(1).csv')

# Label Encoding
le = LabelEncoder()
df['weather'] = le.fit_transform(df['weather'])

# 特徵與目標
X = df[['temp_min', 'temp_max', 'precipitation', 'wind', 'temp_range', 'temp_avg', 'wind_grade', 'precip_3day_avg', 'wind_3day_avg', 'temp_3day_avg', 'rain_streak']]
y = df['weather']

# 切分資料
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# 建立模型
from sklearn.ensemble import RandomForestClassifier
nb_model = RandomForestClassifier(n_estimators=100, random_state=42)
nb_model.fit(X_train, y_train)

# 預測
y_pred = nb_model.predict(X_test)

pred_df = pd.DataFrame({
    'temp_min': X_test['temp_min'],
    'temp_max': X_test['temp_max'],
    'precipitation': X_test['precipitation'],
    'wind': X_test['wind'],
    'temp_range': X_test['temp_range'],
    'temp_avg': X_test['temp_avg'],
    'wind_grade': X_test['wind_grade'],
    'precip_3day_avg': X_test['precip_3day_avg'],
    'wind_3day_avg': X_test['wind_3day_avg'],
    'temp_3day_avg': X_test['temp_3day_avg'],
    'rain_streak': X_test['rain_streak'],
    'actual_weather': le.inverse_transform(y_test),
    'predicted_weather': le.inverse_transform(y_pred)
})

# 印出前20筆結果
print(pred_df.head(20))

# 計算準確率、召回率與精確率（多類別：使用 macro 平均）
accuracy = accuracy_score(y_test, y_pred)
recall = recall_score(y_test, y_pred, average='macro')
precision = precision_score(y_test, y_pred, average='macro')

# 印出評估結果：準確率、召回率及精確率
print(f"Accuracy: {accuracy:.2f}")
print(f"Recall (Macro): {recall:.2f}")
print(f"Precision (Macro): {precision:.2f}")

# 額外：印出詳細分類報告（每個類別的 precision/recall/f1）
print("\nClassification Report:")
print(classification_report(y_test, y_pred, target_names=le.classes_))
